{% extends "base.html" %}
{% block title %}Mailbox Manager | Deep Blue Portal{% endblock %}

{% block content %}
<section class="email-rules">
  <!-- Header Row -->
  <div class="email-rules-header">
    <div class="header-left">
      <h1>Mailbox Manager</h1>
      <p class="mailbox-subtitle">
        <a href="#" class="mailbox-link">
          {{ mailbox or 'luberef@deepblueshipping.com' }}
          <span class="chevron">â–¼</span>
        </a>
      </p>
    </div>
    <div class="header-right">
      <input
        type="text"
        id="searchInput"
        class="search-bar"
        placeholder="Search categories, ships, or dates..."
      />
      <button id="openModal" class="header-add-btn" title="Add New Category">+</button>
    </div>
  </div>

  <!-- Description -->
  <p>Manage automatic email tagging categories and rules for Luberef messages.</p>

  <!-- Cards Section -->
  <section class="cards" id="categoryList">
    {% for cat in categories %}
      {% set parts = cat.displayName.split(' - ') %}
      {% set ref = (parts[0] if parts|length>0 else '').strip() %}
      {% set ship = (parts[1] if parts|length>1 else '').strip() %}
      {% set cpdate = (parts[2] if parts|length>2 else '').strip() %}

      {% set colors = {
        'preset0':'#b4a0ff','preset1':'#92c353','preset2':'#00b7c3',
        'preset3':'#b4009e','preset4':'#0078d4','preset5':'#00cc6a',
        'preset6':'#ff8c00','preset7':'#e3008c','preset8':'#f7630c',
        'preset9':'#a4262c','preset10':'#bad80a','preset11':'#002050',
        'preset12':'#498205','preset13':'#515c6b','preset14':'#ffb900',
        'preset15':'#800000','preset16':'#5c005c'
      } %}
      {% set hex = colors.get(cat.color, '#ccc') %}

      <article class="card" data-search="{{ cat.displayName | lower }}">
        <div class="card-header">
          <span class="color-dot" style="background-color: {{ hex }}"></span>

          <!-- Title opens modal pre-filled -->
          <a href="#" class="card-title edit-category"
             data-ref="{{ ref }}"
             data-ship="{{ ship }}"
             data-cpdate="{{ cpdate }}"
             data-color="{{ cat.color }}">
            {{ cat.displayName }}
          </a>

          {% if cat.rule_exists %}
            <span class="status-pill status-ok">Rule Exists</span>
          {% else %}
            <span class="status-pill status-missing">No Rule</span>
          {% endif %}

          <div class="kebab-wrap">
            <button class="kebab-btn" aria-haspopup="true" aria-expanded="false" title="More actions">â‹¯</button>
            <div class="kebab-menu">
              <div class="submenu">
                <button class="menu-row submenu-trigger">â–¶ Run Rule â–¸</button>
                <div class="submenu-panel">
                  <form action="/email/run_rule/{{ cat.displayName }}" method="get"><button type="submit" class="menu-row">Last 90 Days</button><input type="hidden" name="days" value="90"></form>
                  <form action="/email/run_rule/{{ cat.displayName }}" method="get"><button type="submit" class="menu-row">Last 6 Months</button><input type="hidden" name="days" value="180"></form>
                  <form action="/email/run_rule/{{ cat.displayName }}" method="get"><button type="submit" class="menu-row">Last 1 Year</button><input type="hidden" name="days" value="365"></form>
                  <form action="/email/run_rule/{{ cat.displayName }}" method="get"><button type="submit" class="menu-row">Last 2 Years</button><input type="hidden" name="days" value="730"></form>
                  <form action="/email/run_rule/{{ cat.displayName }}" method="get"><button type="submit" class="menu-row">Last 3 Years</button><input type="hidden" name="days" value="1095"></form>
                  <form action="/email/run_rule/{{ cat.displayName }}" method="get"><button type="submit" class="menu-row">All Years</button><input type="hidden" name="days" value="9999"></form>
                </div>
              </div>

              <form action="/email/create_rule/{{ cat.displayName }}" method="get">
                <button type="submit" class="menu-row">âš™ Create Rule</button>
              </form>

              <form action="/email/delete/{{ cat.id }}" method="get" onsubmit="return confirm('Delete this category and its rule?');">
                <button type="submit" class="menu-row">ðŸ—‘ Delete</button>
              </form>
            </div>
          </div>
        </div>
      </article>
    {% endfor %}
  </section>



  <!-- Modal -->
  <div id="categoryModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h3>Create or Edit Category</h3>
      <form id="createCategoryForm">
        <label>Reference</label>
        <input type="text" name="reference" required>
        <label>Ship Name</label>
        <input type="text" name="ship" required>
        <label>CP Date (e.g. 04Feb25)</label>
        <input type="text" name="cpdate" required>
        <label>Color</label>
        <select name="color">
          {% for i in range(17) %}
            <option value="preset{{ i }}">preset{{ i }}</option>
          {% endfor %}
        </select>
        <div class="form-actions">
          <button type="submit">Create Category</button>
          <button type="button" id="createRuleBtn" class="action-btn">Create Rule</button>
          <button type="button" id="saveChangesBtn" class="action-btn secondary-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Progress Overlay -->
  <div id="progressOverlay">
    <h2>ðŸ“¡ Running Rule...</h2>
    <div id="progressContainer"><div id="progressBar"></div></div>
    <div id="progressLog"></div>
    <button id="closeProgressBtn">Close</button>
  </div>
</section>

<!-- Page-specific JS -->
<script src="{{ url_for('static', filename='js/email_rules.js') }}"></script>

{% endblock %}